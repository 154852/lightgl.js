/*
 * lightgl.js
 * http://github.com/evanw/lightgl.js/
 *
 * Copyright 2011 Evan Wallace
 * Released under the MIT license
 */
(function(){function y(d){window.handleError&&window.handleError(d);throw d;}function A(d){return new Vector((d&1)*2-1,(d&2)-1,(d&4)/2-1)}window.onload=function(){function d(h){mouseX=h.pageX;mouseY=h.pageY;for(var m=gl.canvas;m;m=m.offsetParent){mouseX-=m.offsetLeft;mouseY-=m.offsetTop}deltaMouseX=mouseX-j;deltaMouseY=mouseY-i;j=mouseX;i=mouseY;h.preventDefault()}function e(h){switch(h){case 8:return"BACKSPACE";case 9:return"TAB";case 13:return"ENTER";case 16:return"SHIFT";case 27:return"ESCAPE";
case 32:return"SPACE";case 37:return"LEFT";case 38:return"UP";case 39:return"RIGHT";case 40:return"DOWN"}return h>=65&&h<=90?String.fromCharCode(h):h}function c(){var h=new Date;if(gl.autoDraw){window.update&&window.update((h-B)/1E3);window.draw&&window.draw();E(c)}else setTimeout(c,100);B=h}var f=document.createElement("canvas");f.width=800;f.height=600;window.gl=null;try{gl=f.getContext("webgl")}catch(g){}try{gl=gl||f.getContext("experimental-webgl")}catch(k){}gl||y("WebGL not supported");window.LEFT_BUTTON=
1;window.MIDDLE_BUTTON=2;window.RIGHT_BUTTON=4;window.mouseX=window.mouseY=window.deltaMouseX=window.deltaMouseY=0;window.mouseButton=window.mouseButtons=0;window.mouseDragging=false;var j=0,i=0;gl.canvas.onmousedown=function(h){d(h);mouseDragging=true;mouseButton=1<<h.which-1;mouseButtons|=mouseButton;window.mousePressed&&window.mousePressed()};document.onmousemove=function(h){d(h);if(!mouseDragging&&window.mouseMoved)window.mouseMoved();else mouseDragging&&window.mouseDragged&&window.mouseDragged()};
document.onmouseup=function(h){d(h);mouseDragging=false;mouseButton=1<<h.which-1;mouseButtons&=~mouseButton;window.mouseReleased&&window.mouseReleased()};gl.canvas.oncontextmenu=function(h){h.preventDefault()};window.onblur=function(){mouseDragging=false;mouseButtons=0;keys={}};window.key=null;window.keys={};document.onkeydown=function(h){if(!h.altKey&&!h.ctrlKey&&!h.metaKey){key=e(h.keyCode);keys[key]=true;window.keyPressed&&window.keyPressed()}};document.onkeyup=function(h){if(!h.altKey&&!h.ctrlKey&&
!h.metaKey){key=e(h.keyCode);keys[key]=false;window.keyReleased&&window.keyReleased()}};gl.fullscreen=function(h){h=h||{};var m=h.paddingTop||0,o=h.paddingLeft||0,q=h.paddingRight||0,u=h.paddingBottom||0;document.body.appendChild(gl.canvas);gl.canvas.style.position="absolute";gl.canvas.style.left=o+"px";gl.canvas.style.top=m+"px";window.onresize=function(){gl.canvas.width=window.innerWidth-o-q;gl.canvas.height=window.innerHeight-m-u;gl.viewport(0,0,gl.canvas.width,gl.canvas.height);if(h.camera||!("camera"in
h)){gl.matrixMode(gl.PROJECTION);gl.loadIdentity();gl.perspective(h.fov||45,gl.canvas.width/gl.canvas.height,h.near||0.1,h.far||1E3);gl.matrixMode(gl.MODELVIEW)}C&&draw()};window.onresize()};gl.MODELVIEW=305397761;gl.PROJECTION=305397762;var l=new Matrix,p=new Matrix;gl.modelviewMatrix=new Matrix;gl.projectionMatrix=new Matrix;var n=[],t=[],v,w;gl.matrixMode=function(h){switch(h){case gl.MODELVIEW:v="modelviewMatrix";w=n;break;case gl.PROJECTION:v="projectionMatrix";w=t;break;default:y("invalid matrix mode "+
h)}};gl.loadIdentity=function(){Matrix.identity(gl[v])};gl.loadMatrix=function(h){h=h.m;for(var m=gl[v].m,o=0;o<16;o++)m[o]=h[o]};gl.multMatrix=function(h){gl.loadMatrix(Matrix.multiply(gl[v],h,p))};gl.perspective=function(h,m,o,q){gl.multMatrix(Matrix.perspective(h,m,o,q,l))};gl.frustum=function(h,m,o,q,u,r){gl.multMatrix(Matrix.frustum(h,m,o,q,u,r,l))};gl.ortho=function(h,m,o,q,u,r){gl.multMatrix(Matrix.ortho(h,m,o,q,u,r,l))};gl.scale=function(h,m,o){gl.multMatrix(Matrix.scale(h,m,o,l))};gl.translate=
function(h,m,o){gl.multMatrix(Matrix.translate(h,m,o,l))};gl.rotate=function(h,m,o,q){gl.multMatrix(Matrix.rotate(h,m,o,q,l))};gl.lookAt=function(h,m,o,q,u,r,F,G,H){gl.multMatrix(Matrix.lookAt(h,m,o,q,u,r,F,G,H,l))};gl.pushMatrix=function(){w.push(gl[v].m.slice())};gl.popMatrix=function(){gl[v].m=w.pop()};gl.project=function(h,m,o,q,u,r){q=q||gl.modelviewMatrix;u=u||gl.projectionMatrix;r=r||gl.getParameter(gl.VIEWPORT);h=u.transformPoint(q.transformPoint(new Vector(h,m,o)));return new Vector(r[0]+
r[2]*(h.x*0.5+0.5),r[1]+r[3]*(h.y*0.5+0.5),h.z*0.5+0.5)};gl.unProject=function(h,m,o,q,u,r){q=q||gl.modelviewMatrix;u=u||gl.projectionMatrix;r=r||gl.getParameter(gl.VIEWPORT);h=new Vector((h-r[0])/r[2]*2-1,(m-r[1])/r[3]*2-1,o*2-1);return Matrix.inverse(Matrix.multiply(u,q,l),p).transformPoint(h)};gl.matrixMode(gl.MODELVIEW);var s={mesh:new Mesh({normals:false,coords:false,triangles:false}),mode:-1,color:new Vector(1,1,1),pointSize:1,shader:new Shader("uniform float pointSize;attribute vec3 color;varying vec3 c;void main(){c=color;gl_Position=gl_ModelViewProjectionMatrix*vec4(gl_Vertex,1.0);gl_PointSize=pointSize;}",
"varying vec3 c;void main(){gl_FragColor=vec4(c,1.0);}")};s.mesh.addVertexBuffer("colors","color");gl.pointSize=function(h){s.pointSize=h};gl.begin=function(h){if(s.mode!=-1)throw"mismatched gl.begin() and gl.end() calls";s.mode=h;s.mesh.vertices=[];s.mesh.colors=[]};gl.color=function(h,m,o){s.color=arguments.length==1?h.toArray():[h,m,o]};gl.vertex=function(h,m,o){s.mesh.colors.push(s.color);s.mesh.vertices.push(arguments.length==1?
h.toArray():[h,m,o])};gl.end=function(){if(s.mode==-1)throw"mismatched gl.begin() and gl.end() calls";s.mesh.compile();s.shader.uniforms({pointSize:s.pointSize}).draw(s.mesh,s.mode);s.mode=-1};gl.clearColor(0,0,0,1);gl.enable(gl.DEPTH_TEST);var E=window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||function(h){setTimeout(h,1E3/60)},B=new Date;gl.autoDraw=true;var C=false;window.setup&&window.setup();C=true;c()};var I=typeof Float32Array!="undefined";Matrix=function(){var d=Array.prototype.concat.apply([],
arguments);d.length||(d=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]);this.m=I?new Float32Array(d):d};Matrix.prototype.inverse=function(){return Matrix.inverse(this,new Matrix)};Matrix.prototype.transpose=function(){return Matrix.transpose(this,new Matrix)};Matrix.prototype.multiply=function(d){return Matrix.multiply(this,d,new Matrix)};Matrix.prototype.transformPoint=function(d){var e=this.m;return(new Vector(e[0]*d.x+e[1]*d.y+e[2]*d.z+e[3],e[4]*d.x+e[5]*d.y+e[6]*d.z+e[7],e[8]*d.x+e[9]*d.y+e[10]*d.z+e[11])).divide(e[12]*
d.x+e[13]*d.y+e[14]*d.z+e[15])};Matrix.prototype.transformVector=function(d){var e=this.m;return new Vector(e[0]*d.x+e[1]*d.y+e[2]*d.z,e[4]*d.x+e[5]*d.y+e[6]*d.z,e[8]*d.x+e[9]*d.y+e[10]*d.z)};Matrix.inverse=function(d,e){e=e||new Matrix;var c=d.m,f=e.m;f[0]=c[5]*c[10]*c[15]-c[5]*c[14]*c[11]-c[6]*c[9]*c[15]+c[6]*c[13]*c[11]+c[7]*c[9]*c[14]-c[7]*c[13]*c[10];f[1]=-c[1]*c[10]*c[15]+c[1]*c[14]*c[11]+c[2]*c[9]*c[15]-c[2]*c[13]*c[11]-c[3]*c[9]*c[14]+c[3]*c[13]*c[10];f[2]=c[1]*c[6]*c[15]-c[1]*c[14]*c[7]-
c[2]*c[5]*c[15]+c[2]*c[13]*c[7]+c[3]*c[5]*c[14]-c[3]*c[13]*c[6];f[3]=-c[1]*c[6]*c[11]+c[1]*c[10]*c[7]+c[2]*c[5]*c[11]-c[2]*c[9]*c[7]-c[3]*c[5]*c[10]+c[3]*c[9]*c[6];f[4]=-c[4]*c[10]*c[15]+c[4]*c[14]*c[11]+c[6]*c[8]*c[15]-c[6]*c[12]*c[11]-c[7]*c[8]*c[14]+c[7]*c[12]*c[10];f[5]=c[0]*c[10]*c[15]-c[0]*c[14]*c[11]-c[2]*c[8]*c[15]+c[2]*c[12]*c[11]+c[3]*c[8]*c[14]-c[3]*c[12]*c[10];f[6]=-c[0]*c[6]*c[15]+c[0]*c[14]*c[7]+c[2]*c[4]*c[15]-c[2]*c[12]*c[7]-c[3]*c[4]*c[14]+c[3]*c[12]*c[6];f[7]=c[0]*c[6]*c[11]-c[0]*
c[10]*c[7]-c[2]*c[4]*c[11]+c[2]*c[8]*c[7]+c[3]*c[4]*c[10]-c[3]*c[8]*c[6];f[8]=c[4]*c[9]*c[15]-c[4]*c[13]*c[11]-c[5]*c[8]*c[15]+c[5]*c[12]*c[11]+c[7]*c[8]*c[13]-c[7]*c[12]*c[9];f[9]=-c[0]*c[9]*c[15]+c[0]*c[13]*c[11]+c[1]*c[8]*c[15]-c[1]*c[12]*c[11]-c[3]*c[8]*c[13]+c[3]*c[12]*c[9];f[10]=c[0]*c[5]*c[15]-c[0]*c[13]*c[7]-c[1]*c[4]*c[15]+c[1]*c[12]*c[7]+c[3]*c[4]*c[13]-c[3]*c[12]*c[5];f[11]=-c[0]*c[5]*c[11]+c[0]*c[9]*c[7]+c[1]*c[4]*c[11]-c[1]*c[8]*c[7]-c[3]*c[4]*c[9]+c[3]*c[8]*c[5];f[12]=-c[4]*c[9]*c[14]+
c[4]*c[13]*c[10]+c[5]*c[8]*c[14]-c[5]*c[12]*c[10]-c[6]*c[8]*c[13]+c[6]*c[12]*c[9];f[13]=c[0]*c[9]*c[14]-c[0]*c[13]*c[10]-c[1]*c[8]*c[14]+c[1]*c[12]*c[10]+c[2]*c[8]*c[13]-c[2]*c[12]*c[9];f[14]=-c[0]*c[5]*c[14]+c[0]*c[13]*c[6]+c[1]*c[4]*c[14]-c[1]*c[12]*c[6]-c[2]*c[4]*c[13]+c[2]*c[12]*c[5];f[15]=c[0]*c[5]*c[10]-c[0]*c[9]*c[6]-c[1]*c[4]*c[10]+c[1]*c[8]*c[6]+c[2]*c[4]*c[9]-c[2]*c[8]*c[5];c=c[0]*f[0]+c[1]*f[4]+c[2]*f[8]+c[3]*f[12];for(var g=0;g<16;g++)f[g]/=c;return e};Matrix.transpose=function(d,e){e=
e||new Matrix;var c=d.m,f=e.m;f[0]=c[0];f[1]=c[4];f[2]=c[8];f[3]=c[12];f[4]=c[1];f[5]=c[5];f[6]=c[9];f[7]=c[13];f[8]=c[2];f[9]=c[6];f[10]=c[10];f[10]=c[14];f[12]=c[3];f[13]=c[7];f[14]=c[11];f[15]=c[15];return e};Matrix.multiply=function(d,e,c){c=c||new Matrix;d=d.m;e=e.m;var f=c.m;f[0]=d[0]*e[0]+d[1]*e[4]+d[2]*e[8]+d[3]*e[12];f[1]=d[0]*e[1]+d[1]*e[5]+d[2]*e[9]+d[3]*e[13];f[2]=d[0]*e[2]+d[1]*e[6]+d[2]*e[10]+d[3]*e[14];f[3]=d[0]*e[3]+d[1]*e[7]+d[2]*e[11]+d[3]*e[15];f[4]=d[4]*e[0]+d[5]*e[4]+d[6]*e[8]+
d[7]*e[12];f[5]=d[4]*e[1]+d[5]*e[5]+d[6]*e[9]+d[7]*e[13];f[6]=d[4]*e[2]+d[5]*e[6]+d[6]*e[10]+d[7]*e[14];f[7]=d[4]*e[3]+d[5]*e[7]+d[6]*e[11]+d[7]*e[15];f[8]=d[8]*e[0]+d[9]*e[4]+d[10]*e[8]+d[11]*e[12];f[9]=d[8]*e[1]+d[9]*e[5]+d[10]*e[9]+d[11]*e[13];f[10]=d[8]*e[2]+d[9]*e[6]+d[10]*e[10]+d[11]*e[14];f[11]=d[8]*e[3]+d[9]*e[7]+d[10]*e[11]+d[11]*e[15];f[12]=d[12]*e[0]+d[13]*e[4]+d[14]*e[8]+d[15]*e[12];f[13]=d[12]*e[1]+d[13]*e[5]+d[14]*e[9]+d[15]*e[13];f[14]=d[12]*e[2]+d[13]*e[6]+d[14]*e[10]+d[15]*e[14];
f[15]=d[12]*e[3]+d[13]*e[7]+d[14]*e[11]+d[15]*e[15];return c};Matrix.identity=function(d){d=d||new Matrix;var e=d.m;e[0]=e[5]=e[10]=e[15]=1;e[1]=e[2]=e[3]=e[4]=e[6]=e[7]=e[8]=e[9]=e[11]=e[12]=e[13]=e[14]=0;return d};Matrix.perspective=function(d,e,c,f,g){d=Math.tan(d*Math.PI/360)*c;e=d*e;return Matrix.frustum(-e,e,-d,d,c,f,g)};Matrix.frustum=function(d,e,c,f,g,k,j){j=j||new Matrix;var i=j.m;i[0]=2*g/(e-d);i[1]=0;i[2]=(e+d)/(e-d);i[3]=0;i[4]=0;i[5]=2*g/(f-c);i[6]=(f+c)/(f-c);i[7]=0;i[8]=0;i[9]=0;i[10]=
-(k+g)/(k-g);i[11]=-2*k*g/(k-g);i[12]=0;i[13]=0;i[14]=-1;i[15]=0;return j};Matrix.ortho=function(d,e,c,f,g,k,j){j=j||new Matrix;var i=j.m;i[0]=2/(e-d);i[1]=0;i[2]=0;i[3]=(e+d)/(e-d);i[4]=0;i[5]=2/(f-c);i[6]=0;i[7]=(f+c)/(f-c);i[8]=0;i[9]=0;i[10]=-2/(k-g);i[11]=(k+g)/(k-g);i[12]=0;i[13]=0;i[14]=0;i[15]=1;return j};Matrix.scale=function(d,e,c,f){f=f||new Matrix;var g=f.m;g[0]=d;g[1]=0;g[2]=0;g[3]=0;g[4]=0;g[5]=e;g[6]=0;g[7]=0;g[8]=0;g[9]=0;g[10]=c;g[11]=0;g[12]=0;g[13]=0;g[14]=0;g[15]=1;return f};Matrix.translate=
function(d,e,c,f){f=f||new Matrix;var g=f.m;g[0]=1;g[1]=0;g[2]=0;g[3]=d;g[4]=0;g[5]=1;g[6]=0;g[7]=e;g[8]=0;g[9]=0;g[10]=1;g[11]=c;g[12]=0;g[13]=0;g[14]=0;g[15]=1;return f};Matrix.rotate=function(d,e,c,f,g){if(!d||!e&&!c&&!f)return Matrix.identity(g);g=g||new Matrix;var k=g.m,j=Math.sqrt(e*e+c*c+f*f);d*=Math.PI/180;e/=j;c/=j;f/=j;j=Math.cos(d);d=Math.sin(d);var i=1-j;k[0]=e*e*i+j;k[1]=e*c*i-f*d;k[2]=e*f*i+c*d;k[3]=0;k[4]=c*e*i+f*d;k[5]=c*c*i+j;k[6]=c*f*i-e*d;k[7]=0;k[8]=f*e*i-c*d;k[9]=f*c*i+e*d;k[10]=
f*f*i+j;k[11]=0;k[12]=0;k[13]=0;k[14]=0;k[15]=1;return g};Matrix.lookAt=function(d,e,c,f,g,k,j,i,l,p){p=p||new Matrix;var n=p.m;d=new Vector(d,e,c);f=new Vector(f,g,k);i=new Vector(j,i,l);j=d.subtract(f).unit();i=i.cross(j).unit();l=j.cross(i).unit();n[0]=i.x;n[1]=i.y;n[2]=i.z;n[3]=-i.dot(d);n[4]=l.x;n[5]=l.y;n[6]=l.z;n[7]=-l.dot(d);n[8]=j.x;n[9]=j.y;n[10]=j.z;n[11]=-j.dot(d);n[12]=0;n[13]=0;n[14]=0;n[15]=1;return p};Indexer=function(){this.unique=[];this.indices=[];this.map={}};Indexer.prototype.add=
function(d){var e=JSON.stringify(d);if(!(e in this.map)){this.map[e]=this.unique.length;this.unique.push(d)}return this.map[e]};Buffer=function(d,e){this.buffer=null;this.target=d;this.type=e;this.data=[]};Buffer.prototype.compile=function(d){for(var e=[],c=0;c<this.data.length;c+=1E4)e=Array.prototype.concat.apply(e,this.data.slice(c,c+1E4));if(e.length){this.buffer=this.buffer||gl.createBuffer();this.buffer.length=e.length;this.buffer.spacing=e.length/this.data.length;gl.bindBuffer(this.target,
this.buffer);gl.bufferData(this.target,new this.type(e),d||gl.STATIC_DRAW)}};Mesh=function(d){d=d||{};this.vertexBuffers={};this.indexBuffers={};this.addVertexBuffer("vertices","gl_Vertex");if(!("coords"in d)||d.coords)this.addVertexBuffer("coords","gl_TexCoord");if(!("normals"in d)||d.normals)this.addVertexBuffer("normals","gl_Normal");if(!("triangles"in d)||d.triangles)this.addIndexBuffer("triangles");d.lines&&this.addIndexBuffer("lines")};Mesh.prototype.addVertexBuffer=function(d,e){(this.vertexBuffers[e]=
new Buffer(gl.ARRAY_BUFFER,Float32Array)).name=d;this[d]=[]};Mesh.prototype.addIndexBuffer=function(d){this.indexBuffers[d]=new Buffer(gl.ELEMENT_ARRAY_BUFFER,Int16Array);this[d]=[]};Mesh.prototype.compile=function(){for(var d in this.vertexBuffers){var e=this.vertexBuffers[d];e.data=this[e.name];e.compile()}for(var c in this.indexBuffers){e=this.indexBuffers[c];e.data=this[c];e.compile()}};Mesh.prototype.transform=function(d){this.vertices=this.vertices.map(function(c){return d.transformPoint(Vector.fromArray(c)).toArray()});
if(this.normals){var e=d.inverse().transpose();this.normals=this.normals.map(function(c){return e.transformVector(Vector.fromArray(c)).unit().toArray()})}this.compile();return this};Mesh.prototype.computeNormals=function(){this.normals||this.addVertexBuffer("normals","gl_Normal");for(var d=0;d<this.vertices.length;d++)this.normals[d]=new Vector;for(d=0;d<this.triangles.length;d++){var e=this.triangles[d],c=Vector.fromArray(this.vertices[e[0]]),f=Vector.fromArray(this.vertices[e[1]]),g=Vector.fromArray(this.vertices[e[2]]);
c=f.subtract(c).cross(g.subtract(c)).unit();this.normals[e[0]]=this.normals[e[0]].add(c);this.normals[e[1]]=this.normals[e[1]].add(c);this.normals[e[2]]=this.normals[e[2]].add(c)}for(d=0;d<this.vertices.length;d++)this.normals[d]=this.normals[d].unit().toArray();this.compile();return this};Mesh.prototype.computeWireframe=function(){for(var d=new Indexer,e=0;e<this.triangles.length;e++)for(var c=this.triangles[e],f=0;f<c.length;f++){var g=c[f],k=c[(f+1)%c.length];d.add([Math.min(g,k),Math.max(g,k)])}this.lines||
this.addIndexBuffer("lines");this.lines=d.unique;this.compile();return this};Mesh.prototype.getAABB=function(){var d={min:new Vector(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE)};d.max=d.min.negative();for(var e=0;e<this.vertices.length;e++){var c=Vector.fromArray(this.vertices[e]);d.min=Vector.min(d.min,c);d.max=Vector.max(d.max,c)}return d};Mesh.prototype.getBoundingSphere=function(){var d=this.getAABB();d={center:d.min.add(d.max).divide(2),radius:0};for(var e=0;e<this.vertices.length;e++)d.radius=
Math.max(d.radius,Vector.fromArray(this.vertices[e]).subtract(d.center).length());return d};Mesh.plane=function(d,e,c){c=new Mesh(c);d=d||1;e=e||1;for(var f=0;f<=e;f++)for(var g=f/e,k=0;k<=d;k++){var j=k/d;c.vertices.push([2*j-1,2*g-1,0]);c.coords&&c.coords.push([j,g]);c.normals&&c.normals.push([0,0,1]);if(k<d&&f<e){j=k+f*(d+1);c.triangles.push([j,j+1,j+d+1]);c.triangles.push([j+d+1,j+1,j+d+2])}}c.compile();return c};var D=[[0,4,2,6,-1,0,0],[1,3,5,7,+1,0,0],[0,1,4,5,0,-1,0],[2,6,3,7,0,+1,0],[0,2,
1,3,0,0,-1],[4,5,6,7,0,0,+1]];Mesh.cube=function(d){d=new Mesh(d);for(var e=0;e<D.length;e++){for(var c=D[e],f=e*4,g=0;g<4;g++){d.vertices.push(A(c[g]).toArray());d.coords&&d.coords.push([g&1,(g&2)/2]);d.normals&&d.normals.push([c[4],c[5],c[6]])}d.triangles.push([f,f+1,f+2]);d.triangles.push([f+2,f+1,f+3])}d.compile();return d};Mesh.sphere=function(d,e){var c=new Mesh(e),f=new Indexer;d=d||6;for(var g=0;g<8;g++)for(var k=A(g),j=k.x*k.y*k.z>0,i=[],l=0;l<=d;l++){for(var p=0;l+p<=d;p++){var n=l/d,t=
p/d,v=(d-l-p)/d;t={vertex:(new Vector(n+(n-n*n)/2,t+(t-t*t)/2,v+(v-v*v)/2)).unit().multiply(k).toArray()};if(c.coords)t.coord=k.y>0?[1-n,v]:[v,1-n];i.push(f.add(t))}if(l>0)for(p=0;l+p<=d;p++){n=(l-1)*(d+1)+(l-1-(l-1)*(l-1))/2+p;t=l*(d+1)+(l-l*l)/2+p;c.triangles.push(j?[i[n],i[t],i[n+1]]:[i[n],i[n+1],i[t]]);l+p<d&&c.triangles.push(j?[i[t],i[t+1],i[n+1]]:[i[t],i[n+1],i[t+1]])}}c.vertices=f.unique.map(function(w){return w.vertex});if(c.coords)c.coords=f.unique.map(function(w){return w.coord});if(c.normals)c.normals=
c.vertices;c.compile();return c};Mesh.load=function(d,e){e=e||{};if(!d.coords)e.coords=false;if(!d.normals)e.normals=false;var c=new Mesh(e);c.vertices=d.vertices;if(c.coords)c.coords=d.coords;if(c.normals)c.normals=d.normals;c.triangles=d.triangles||[];c.lines=d.lines||[];c.compile();return c};HitTest=function(d,e,c){this.t=arguments.length?d:Number.MAX_VALUE;this.hit=e;this.normal=c};HitTest.prototype.mergeWith=function(d){if(d.t>0&&d.t<this.t){this.t=d.t;this.hit=d.hit;this.normal=d.normal}};Raytracer=
function(){var d=gl.getParameter(gl.VIEWPORT),e=gl.modelviewMatrix.m,c=new Vector(e[0],e[4],e[8]),f=new Vector(e[1],e[5],e[9]),g=new Vector(e[2],e[6],e[10]);e=new Vector(e[3],e[7],e[11]);this.eye=new Vector(-e.dot(c),-e.dot(f),-e.dot(g));c=d[0];f=c+d[2];g=d[1];e=g+d[3];this.ray00=gl.unProject(c,g,1).subtract(this.eye);this.ray10=gl.unProject(f,g,1).subtract(this.eye);this.ray01=gl.unProject(c,e,1).subtract(this.eye);this.ray11=gl.unProject(f,e,1).subtract(this.eye);this.viewport=d};Raytracer.prototype.getRayForPixel=
function(d,e){d=(d-this.viewport[0])/this.viewport[2];e=1-(e-this.viewport[1])/this.viewport[3];var c=Vector.lerp(this.ray00,this.ray10,d),f=Vector.lerp(this.ray01,this.ray11,d);return Vector.lerp(c,f,e).unit()};Raytracer.hitTestBox=function(d,e,c,f){var g=c.subtract(d).divide(e),k=f.subtract(d).divide(e),j=Vector.min(g,k);g=Vector.max(g,k);j=j.max();g=g.min();if(j>0&&j<g){d=d.add(e.multiply(j));c=c.add(1.0E-6);f=f.subtract(1.0E-6);return new HitTest(j,d,new Vector((d.x>f.x)-(d.x<c.x),(d.y>f.y)-(d.y<
c.y),(d.z>f.z)-(d.z<c.z)))}return null};Raytracer.hitTestSphere=function(d,e,c,f){var g=d.subtract(c),k=e.dot(e),j=2*e.dot(g);g=g.dot(g)-f*f;g=j*j-4*k*g;if(g>0){k=(-j-Math.sqrt(g))/(2*k);d=d.add(e.multiply(k));return new HitTest(k,d,d.subtract(c).divide(f))}return null};Raytracer.hitTestTriangle=function(d,e,c,f,g){var k=f.subtract(c),j=g.subtract(c);g=k.cross(j).unit();f=g.dot(c.subtract(d)).divide(g.dot(e));if(f>0){d=d.add(e.multiply(f));var i=d.subtract(c);c=j.dot(j);e=j.dot(k);j=j.dot(i);var l=
k.dot(k);k=k.dot(i);i=c*l-e*e;l=(l*j-e*k)/i;k=(c*k-e*j)/i;if(l>=0&&k>=0&&l+k<=1)return new HitTest(f,d,g)}return null};Shader=function(d,e){function c(j,i,l){for(;(result=j.exec(i))!=null;)l(result)}function f(j,i){var l=/^((\s*\/\/.*\n|\s*#extension.*\n)+)[^]*$/.exec(i);i=l?l[1]+j+i.substr(l[1].length):j+i;c(/\bgl_\w+\b/g,j,function(p){i=i.replace(RegExp(p,"g"),"_"+p)});return i}function g(j,i){var l=gl.createShader(j);gl.shaderSource(l,i);gl.compileShader(l);gl.getShaderParameter(l,gl.COMPILE_STATUS)||
y("compile error: "+gl.getShaderInfoLog(l));return l}d=f("attribute vec3 gl_Vertex;attribute vec2 gl_TexCoord;attribute vec3 gl_Normal;uniform mat4 gl_ModelViewMatrix;uniform mat4 gl_ProjectionMatrix;uniform mat4 gl_ModelViewProjectionMatrix;",d);e=f("precision highp float;uniform mat4 gl_ModelViewMatrix;uniform mat4 gl_ProjectionMatrix;uniform mat4 gl_ModelViewProjectionMatrix;",e);this.program=gl.createProgram();
gl.attachShader(this.program,g(gl.VERTEX_SHADER,d));gl.attachShader(this.program,g(gl.FRAGMENT_SHADER,e));gl.linkProgram(this.program);gl.getProgramParameter(this.program,gl.LINK_STATUS)||y("link error: "+gl.getProgramInfoLog(this.program));this.attributes={};var k={};c(/uniform\s+sampler(1D|2D|3D|Cube)\s+(\w+)\s*;/g,d+e,function(j){k[j[2]]=1});this.isSampler=k;this.needsMVP=(d+e).indexOf("gl_ModelViewProjectionMatrix")!=-1};Shader.prototype.uniforms=function(d){gl.useProgram(this.program);for(var e in d){var c=
gl.getUniformLocation(this.program,e);if(c){var f=d[e];if(f instanceof Vector)f=[f.x,f.y,f.z];else if(f instanceof Matrix)f=f.m;var g=Object.prototype.toString.call(f);if(g=="[object Array]"||g=="[object Float32Array]")switch(f.length){case 1:gl.uniform1fv(c,new Float32Array(f));break;case 2:gl.uniform2fv(c,new Float32Array(f));break;case 3:gl.uniform3fv(c,new Float32Array(f));break;case 4:gl.uniform4fv(c,new Float32Array(f));break;case 9:gl.uniformMatrix3fv(c,false,new Float32Array([f[0],f[3],f[6],
f[1],f[4],f[7],f[2],f[5],f[8]]));break;case 16:gl.uniformMatrix4fv(c,false,new Float32Array([f[0],f[4],f[8],f[12],f[1],f[5],f[9],f[13],f[2],f[6],f[10],f[14],f[3],f[7],f[11],f[15]]));break;default:y("don't know how to load uniform \""+e+'" of length '+f.length)}else Object.prototype.toString.call(f)=="[object Number]"?(this.isSampler[e]?gl.uniform1i:gl.uniform1f).call(gl,c,f):y('attempted to set uniform "'+e+'" to invalid value '+f)}}return this};Shader.prototype.draw=function(d,e){this.drawBuffers(d.vertexBuffers,
d.indexBuffers[e==gl.LINES?"lines":"triangles"],arguments.length<2?gl.TRIANGLES:e)};Shader.prototype.drawBuffers=function(d,e,c){this.uniforms({_gl_ModelViewMatrix:gl.modelviewMatrix,_gl_ProjectionMatrix:gl.projectionMatrix});this.needsMVP&&this.uniforms({_gl_ModelViewProjectionMatrix:gl.projectionMatrix.multiply(gl.modelviewMatrix)});var f=0,g;for(g in d){var k=d[g],j=this.attributes[g]||gl.getAttribLocation(this.program,g.replace(/^gl_/,"_gl_"));if(j!=-1){this.attributes[g]=j;gl.bindBuffer(gl.ARRAY_BUFFER,
k.buffer);gl.enableVertexAttribArray(j);gl.vertexAttribPointer(j,k.buffer.spacing,gl.FLOAT,false,0,0);f=k.buffer.length/k.buffer.spacing}}for(g in this.attributes)g in d||gl.disableVertexAttribArray(this.attributes[g]);if(e){gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,e.buffer);gl.drawElements(c,e.buffer.length,gl.UNSIGNED_SHORT,0)}else gl.drawArrays(c,0,f);return this};Texture=function(d,e,c){c=c||{};this.id=gl.createTexture();this.width=d;this.height=e;this.format=c.format||gl.RGBA;this.type=c.type||
gl.UNSIGNED_BYTE;gl.bindTexture(gl.TEXTURE_2D,this.id);gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL,1);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,c.filter||c.magFilter||gl.LINEAR);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,c.filter||c.minFilter||gl.LINEAR);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,c.wrap||c.wrapS||gl.CLAMP_TO_EDGE);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,c.wrap||c.wrapT||gl.CLAMP_TO_EDGE);gl.texImage2D(gl.TEXTURE_2D,0,this.format,d,e,0,this.format,this.type,
null)};Texture.prototype.bind=function(d){gl.activeTexture(gl.TEXTURE0+(d||0));gl.bindTexture(gl.TEXTURE_2D,this.id)};Texture.prototype.unbind=function(d){gl.activeTexture(gl.TEXTURE0+(d||0));gl.bindTexture(gl.TEXTURE_2D,null)};var z,x;Texture.prototype.drawTo=function(d){var e=gl.getParameter(gl.VIEWPORT);z=z||gl.createFramebuffer();x=x||gl.createRenderbuffer();gl.bindFramebuffer(gl.FRAMEBUFFER,z);gl.bindRenderbuffer(gl.RENDERBUFFER,x);if(this.width!=x.width||this.height!=x.height){x.width=this.width;
x.height=this.height;gl.renderbufferStorage(gl.RENDERBUFFER,gl.DEPTH_COMPONENT16,this.width,this.height)}gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.TEXTURE_2D,this.id,0);gl.framebufferRenderbuffer(gl.FRAMEBUFFER,gl.DEPTH_ATTACHMENT,gl.RENDERBUFFER,x);gl.viewport(0,0,this.width,this.height);d();gl.bindFramebuffer(gl.FRAMEBUFFER,null);gl.bindRenderbuffer(gl.RENDERBUFFER,null);gl.viewport(e[0],e[1],e[2],e[3])};Texture.prototype.swapWith=function(d){var e;e=d.id;d.id=this.id;this.id=
e;e=d.width;d.width=this.width;this.width=e;e=d.height;d.height=this.height;this.height=e};Texture.fromImage=function(d,e){e=e||{};var c=new Texture(d.width,d.height,e);gl.texImage2D(gl.TEXTURE_2D,0,c.format,c.format,c.type,d);e.minFilter&&e.minFilter!=gl.NEAREST&&e.minFilter!=gl.LINEAR&&gl.generateMipmap(gl.TEXTURE_2D);return c};Vector=function(d,e,c){this.x=d||0;this.y=e||0;this.z=c||0};Vector.prototype.negative=function(){return new Vector(-this.x,-this.y,-this.z)};Vector.prototype.add=function(){return b instanceof
Vector?new Vector(a.x+b.x,a.y+b.y,a.z+b.z):new Vector(a.x+b,a.y+b,a.z+b)};Vector.prototype.subtract=function(){return b instanceof Vector?new Vector(a.x-b.x,a.y-b.y,a.z-b.z):new Vector(a.x-b,a.y-b,a.z-b)};Vector.prototype.multiply=function(){return b instanceof Vector?new Vector(a.x*b.x,a.y*b.y,a.z*b.z):new Vector(a.x*b,a.y*b,a.z*b)};Vector.prototype.divide=function(){return b instanceof Vector?new Vector(a.x/b.x,a.y/b.y,a.z/b.z):new Vector(a.x/b,a.y/b,a.z/b)};Vector.prototype.equals=function(d){return this.x==
d.x&&this.y==d.y&&this.z==d.z};Vector.prototype.dot=function(d){return this.x*d.x+this.y*d.y+this.z*d.z};Vector.prototype.cross=function(d){return new Vector(this.y*d.z-this.z*d.y,this.z*d.x-this.x*d.z,this.x*d.y-this.y*d.x)};Vector.prototype.length=function(){return Math.sqrt(this.dot(this))};Vector.prototype.unit=function(){return this.divide(this.length())};Vector.prototype.min=function(){return Math.min(Math.min(this.x,this.y),this.z)};Vector.prototype.max=function(){return Math.max(Math.max(this.x,
this.y),this.z)};Vector.prototype.toAngles=function(){return{theta:Math.atan2(this.z,this.x),phi:Math.asin(this.y/this.length())}};Vector.prototype.toArray=function(d){return[this.x,this.y,this.z].slice(0,d||3)};Vector.prototype.clone=function(){return new Vector(this.x,this.y,this.z)};Vector.prototype.init=function(d,e,c){this.x=d;this.y=e;this.z=c;return this};Vector.negative=function(d,e){e.x=-d.x;e.y=-d.y;e.z=-d.z;return e};Vector.add=function(d,e,c){if(e instanceof Vector){c.x=d.x+e.x;c.y=d.y+
e.y;c.z=d.z+e.z}else{c.x=d.x+e;c.y=d.y+e;c.z=d.z+e}return c};Vector.subtract=function(d,e,c){if(e instanceof Vector){c.x=d.x-e.x;c.y=d.y-e.y;c.z=d.z-e.z}else{c.x=d.x-e;c.y=d.y-e;c.z=d.z-e}return c};Vector.multiply=function(d,e,c){if(e instanceof Vector){c.x=d.x*e.x;c.y=d.y*e.y;c.z=d.z*e.z}else{c.x=d.x*e;c.y=d.y*e;c.z=d.z*e}return c};Vector.divide=function(d,e,c){if(e instanceof Vector){c.x=d.x/e.x;c.y=d.y/e.y;c.z=d.z/e.z}else{c.x=d.x/e;c.y=d.y/e;c.z=d.z/e}return c};Vector.cross=function(d,e,c){c.x=
d.y*e.z-d.z*e.y;c.y=d.z*e.x-d.x*e.z;c.z=d.x*e.y-d.y*e.x;return c};Vector.unit=function(d,e){var c=d.length();e.x=d.x/c;e.y=d.y/c;e.z=d.z/c;return e};Vector.fromAngles=function(d,e){return new Vector(Math.cos(d)*Math.cos(e),Math.sin(e),Math.sin(d)*Math.cos(e))};Vector.randomDirection=function(){return Vector.fromAngles(Math.random()*Math.PI*2,Math.asin(Math.random()*2-1))};Vector.min=function(d,e){return new Vector(Math.min(d.x,e.x),Math.min(d.y,e.y),Math.min(d.z,e.z))};Vector.max=function(d,e){return new Vector(Math.max(d.x,
e.x),Math.max(d.y,e.y),Math.max(d.z,e.z))};Vector.lerp=function(d,e,c){return e.subtract(d).multiply(c).add(d)};Vector.fromArray=function(d){return new Vector(d[0],d[1],d[2])}})();
