<!DOCTYPE html>  <html> <head>   <title>shader.js</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="main.html">                 main.js               </a>                                           <a class="source" href="matrix.html">                 matrix.js               </a>                                           <a class="source" href="mesh.html">                 mesh.js               </a>                                           <a class="source" href="raytracer.html">                 raytracer.js               </a>                                           <a class="source" href="shader.html">                 shader.js               </a>                                           <a class="source" href="texture.html">                 texture.js               </a>                                           <a class="source" href="vector.html">                 vector.js               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               shader.js             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p>Provides a convenient wrapper for WebGL shaders. A few uniforms and attributes,
prefixed with <code>gl_</code>, are automatically added to all shader sources to make
simple shaders easier to write.</p>

<p>Example usage:</p>

<pre><code>var shader = new Shader('\
    void main() {\
        gl_Position = gl_ModelViewProjectionMatrix\
                      * vec4(gl_Vertex, 1.0);\
    }\
', '\
    uniform vec3 color;\
    void main() {\
        gl_FragColor = vec4(color, 1.0);\
    }\
');

shader.uniforms({
    color: [1, 0, 0]
}).draw(mesh);
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <h3>new Shader(vertexSource, fragmentSource)</h3>

<p>Compiles a shader program using the provided vertex and fragment shaders.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Shader</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">vertexSource</span><span class="p">,</span> <span class="nx">fragmentSource</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>Headers are prepended to the sources to provide some automatic functionality.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">header</span> <span class="o">=</span> <span class="s1">&#39;\</span>
<span class="s1">        uniform mat4 gl_ModelViewMatrix;\</span>
<span class="s1">        uniform mat4 gl_ProjectionMatrix;\</span>
<span class="s1">        uniform mat4 gl_ModelViewProjectionMatrix;\</span>
<span class="s1">    &#39;</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">vertexHeader</span> <span class="o">=</span> <span class="s1">&#39;\</span>
<span class="s1">        attribute vec3 gl_Vertex;\</span>
<span class="s1">        attribute vec2 gl_TexCoord;\</span>
<span class="s1">        attribute vec3 gl_Normal;\</span>
<span class="s1">    &#39;</span> <span class="o">+</span> <span class="nx">header</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">fragmentHeader</span> <span class="o">=</span> <span class="s1">&#39;\</span>
<span class="s1">        precision highp float;\</span>
<span class="s1">    &#39;</span> <span class="o">+</span> <span class="nx">header</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>The <code>gl_</code> prefix must be substituted for something else to avoid compile errors,
since it's a reserved prefix. This prefixes all reserved names with <code>_</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">function</span> <span class="nx">regexMap</span><span class="p">(</span><span class="nx">regex</span><span class="p">,</span> <span class="nx">text</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">while</span> <span class="p">((</span><span class="nx">result</span> <span class="o">=</span> <span class="nx">regex</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">text</span><span class="p">))</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">callback</span><span class="p">(</span><span class="nx">result</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Insert the header after any extensions, since those must come first.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">function</span> <span class="nx">fix</span><span class="p">(</span><span class="nx">header</span><span class="p">,</span> <span class="nx">source</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">match</span> <span class="o">=</span> <span class="sr">/^((\s*\/\/.*\n|\s*#extension.*\n)+)[^]*$/</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">source</span><span class="p">);</span>
        <span class="nx">source</span> <span class="o">=</span> <span class="nx">match</span> <span class="o">?</span> <span class="nx">match</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="nx">header</span> <span class="o">+</span> <span class="nx">source</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="nx">match</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">length</span><span class="p">)</span> <span class="o">:</span> <span class="nx">header</span> <span class="o">+</span> <span class="nx">source</span><span class="p">;</span>
        <span class="nx">regexMap</span><span class="p">(</span><span class="sr">/\bgl_\w+\b/g</span><span class="p">,</span> <span class="nx">header</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">source</span> <span class="o">=</span> <span class="nx">source</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="k">new</span> <span class="nb">RegExp</span><span class="p">(</span><span class="nx">result</span><span class="p">,</span> <span class="s1">&#39;g&#39;</span><span class="p">),</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nx">result</span><span class="p">);</span>
        <span class="p">});</span>
        <span class="k">return</span> <span class="nx">source</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nx">vertexSource</span> <span class="o">=</span> <span class="nx">fix</span><span class="p">(</span><span class="nx">vertexHeader</span><span class="p">,</span> <span class="nx">vertexSource</span><span class="p">);</span>
    <span class="nx">fragmentSource</span> <span class="o">=</span> <span class="nx">fix</span><span class="p">(</span><span class="nx">fragmentHeader</span><span class="p">,</span> <span class="nx">fragmentSource</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Compile and link errors are thrown as strings.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">function</span> <span class="nx">compileSource</span><span class="p">(</span><span class="nx">type</span><span class="p">,</span> <span class="nx">source</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">shader</span> <span class="o">=</span> <span class="nx">gl</span><span class="p">.</span><span class="nx">createShader</span><span class="p">(</span><span class="nx">type</span><span class="p">);</span>
        <span class="nx">gl</span><span class="p">.</span><span class="nx">shaderSource</span><span class="p">(</span><span class="nx">shader</span><span class="p">,</span> <span class="nx">source</span><span class="p">);</span>
        <span class="nx">gl</span><span class="p">.</span><span class="nx">compileShader</span><span class="p">(</span><span class="nx">shader</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">gl</span><span class="p">.</span><span class="nx">getShaderParameter</span><span class="p">(</span><span class="nx">shader</span><span class="p">,</span> <span class="nx">gl</span><span class="p">.</span><span class="nx">COMPILE_STATUS</span><span class="p">))</span> <span class="p">{</span>
            <span class="nx">__error</span><span class="p">(</span><span class="s1">&#39;compile error: &#39;</span> <span class="o">+</span> <span class="nx">gl</span><span class="p">.</span><span class="nx">getShaderInfoLog</span><span class="p">(</span><span class="nx">shader</span><span class="p">));</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nx">shader</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">program</span> <span class="o">=</span> <span class="nx">gl</span><span class="p">.</span><span class="nx">createProgram</span><span class="p">();</span>
    <span class="nx">gl</span><span class="p">.</span><span class="nx">attachShader</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">program</span><span class="p">,</span> <span class="nx">compileSource</span><span class="p">(</span><span class="nx">gl</span><span class="p">.</span><span class="nx">VERTEX_SHADER</span><span class="p">,</span> <span class="nx">vertexSource</span><span class="p">));</span>
    <span class="nx">gl</span><span class="p">.</span><span class="nx">attachShader</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">program</span><span class="p">,</span> <span class="nx">compileSource</span><span class="p">(</span><span class="nx">gl</span><span class="p">.</span><span class="nx">FRAGMENT_SHADER</span><span class="p">,</span> <span class="nx">fragmentSource</span><span class="p">));</span>
    <span class="nx">gl</span><span class="p">.</span><span class="nx">linkProgram</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">program</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">gl</span><span class="p">.</span><span class="nx">getProgramParameter</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">program</span><span class="p">,</span> <span class="nx">gl</span><span class="p">.</span><span class="nx">LINK_STATUS</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">__error</span><span class="p">(</span><span class="s1">&#39;link error: &#39;</span> <span class="o">+</span> <span class="nx">gl</span><span class="p">.</span><span class="nx">getProgramInfoLog</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">program</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">attributes</span> <span class="o">=</span> <span class="p">{};</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>Sampler uniforms need to be uploaded using <code>gl.uniform1i()</code> instead of <code>gl.uniform1f()</code>.
To do this automatically, we detect and remember all uniform samplers in the source code.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">isSampler</span> <span class="o">=</span> <span class="p">{};</span>
    <span class="nx">regexMap</span><span class="p">(</span><span class="sr">/uniform\s+sampler(1D|2D|3D|Cube)\s+(\w+)\s*;/g</span><span class="p">,</span> <span class="nx">vertexSource</span> <span class="o">+</span> <span class="nx">fragmentSource</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">groups</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">isSampler</span><span class="p">[</span><span class="nx">groups</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">});</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">isSampler</span> <span class="o">=</span> <span class="nx">isSampler</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">needsMVP</span> <span class="o">=</span> <span class="p">(</span><span class="nx">vertexSource</span> <span class="o">+</span> <span class="nx">fragmentSource</span><span class="p">).</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;gl_ModelViewProjectionMatrix&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">};</span>

<span class="kd">function</span> <span class="nx">isArray</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">str</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">toString</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">obj</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">str</span> <span class="o">==</span> <span class="s1">&#39;[object Array]&#39;</span> <span class="o">||</span> <span class="nx">str</span> <span class="o">==</span> <span class="s1">&#39;[object Float32Array]&#39;</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">isNumber</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">toString</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;[object Number]&#39;</span><span class="p">;</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <h3>.uniforms(uniforms)</h3>

<p>Set a uniform for each property of <code>uniforms</code>. The correct <code>gl.uniform*()</code> method is
inferred from the value types and from the stored uniform sampler flags.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Shader</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">uniforms</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">uniforms</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">gl</span><span class="p">.</span><span class="nx">useProgram</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">program</span><span class="p">);</span>

    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">name</span> <span class="k">in</span> <span class="nx">uniforms</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">location</span> <span class="o">=</span> <span class="nx">gl</span><span class="p">.</span><span class="nx">getUniformLocation</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">program</span><span class="p">,</span> <span class="nx">name</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">location</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">value</span> <span class="o">=</span> <span class="nx">uniforms</span><span class="p">[</span><span class="nx">name</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">value</span> <span class="k">instanceof</span> <span class="nx">Vector</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">value</span> <span class="o">=</span> <span class="p">[</span><span class="nx">value</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">value</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span> <span class="nx">value</span><span class="p">.</span><span class="nx">z</span><span class="p">];</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">value</span> <span class="k">instanceof</span> <span class="nx">Matrix</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">value</span> <span class="o">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">m</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">value</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">switch</span> <span class="p">(</span><span class="nx">value</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">case</span> <span class="mi">1</span><span class="o">:</span> <span class="nx">gl</span><span class="p">.</span><span class="nx">uniform1fv</span><span class="p">(</span><span class="nx">location</span><span class="p">,</span> <span class="k">new</span> <span class="nx">Float32Array</span><span class="p">(</span><span class="nx">value</span><span class="p">));</span> <span class="k">break</span><span class="p">;</span>
                <span class="k">case</span> <span class="mi">2</span><span class="o">:</span> <span class="nx">gl</span><span class="p">.</span><span class="nx">uniform2fv</span><span class="p">(</span><span class="nx">location</span><span class="p">,</span> <span class="k">new</span> <span class="nx">Float32Array</span><span class="p">(</span><span class="nx">value</span><span class="p">));</span> <span class="k">break</span><span class="p">;</span>
                <span class="k">case</span> <span class="mi">3</span><span class="o">:</span> <span class="nx">gl</span><span class="p">.</span><span class="nx">uniform3fv</span><span class="p">(</span><span class="nx">location</span><span class="p">,</span> <span class="k">new</span> <span class="nx">Float32Array</span><span class="p">(</span><span class="nx">value</span><span class="p">));</span> <span class="k">break</span><span class="p">;</span>
                <span class="k">case</span> <span class="mi">4</span><span class="o">:</span> <span class="nx">gl</span><span class="p">.</span><span class="nx">uniform4fv</span><span class="p">(</span><span class="nx">location</span><span class="p">,</span> <span class="k">new</span> <span class="nx">Float32Array</span><span class="p">(</span><span class="nx">value</span><span class="p">));</span> <span class="k">break</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>Matrices are automatically transposed, since WebGL uses column-major
indices instead of row-major indices.</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="k">case</span> <span class="mi">9</span><span class="o">:</span> <span class="nx">gl</span><span class="p">.</span><span class="nx">uniformMatrix3fv</span><span class="p">(</span><span class="nx">location</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="k">new</span> <span class="nx">Float32Array</span><span class="p">([</span>
                    <span class="nx">value</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">value</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="nx">value</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span>
                    <span class="nx">value</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nx">value</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="nx">value</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span>
                    <span class="nx">value</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="nx">value</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="nx">value</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span>
                <span class="p">]));</span> <span class="k">break</span><span class="p">;</span>
                <span class="k">case</span> <span class="mi">16</span><span class="o">:</span> <span class="nx">gl</span><span class="p">.</span><span class="nx">uniformMatrix4fv</span><span class="p">(</span><span class="nx">location</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="k">new</span> <span class="nx">Float32Array</span><span class="p">([</span>
                    <span class="nx">value</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">value</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="nx">value</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span> <span class="nx">value</span><span class="p">[</span><span class="mi">12</span><span class="p">],</span>
                    <span class="nx">value</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nx">value</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="nx">value</span><span class="p">[</span><span class="mi">9</span><span class="p">],</span> <span class="nx">value</span><span class="p">[</span><span class="mi">13</span><span class="p">],</span>
                    <span class="nx">value</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="nx">value</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="nx">value</span><span class="p">[</span><span class="mi">10</span><span class="p">],</span> <span class="nx">value</span><span class="p">[</span><span class="mi">14</span><span class="p">],</span>
                    <span class="nx">value</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="nx">value</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span> <span class="nx">value</span><span class="p">[</span><span class="mi">11</span><span class="p">],</span> <span class="nx">value</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span>
                <span class="p">]));</span> <span class="k">break</span><span class="p">;</span>
                <span class="k">default</span><span class="o">:</span> <span class="nx">__error</span><span class="p">(</span><span class="s1">&#39;don\&#39;t know how to load uniform &quot;&#39;</span> <span class="o">+</span> <span class="nx">name</span> <span class="o">+</span> <span class="s1">&#39;&quot; of length &#39;</span> <span class="o">+</span> <span class="nx">value</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">isNumber</span><span class="p">(</span><span class="nx">value</span><span class="p">))</span> <span class="p">{</span>
            <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">isSampler</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">?</span> <span class="nx">gl</span><span class="p">.</span><span class="nx">uniform1i</span> <span class="o">:</span> <span class="nx">gl</span><span class="p">.</span><span class="nx">uniform1f</span><span class="p">).</span><span class="nx">call</span><span class="p">(</span><span class="nx">gl</span><span class="p">,</span> <span class="nx">location</span><span class="p">,</span> <span class="nx">value</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">__error</span><span class="p">(</span><span class="s1">&#39;attempted to set uniform &quot;&#39;</span> <span class="o">+</span> <span class="nx">name</span> <span class="o">+</span> <span class="s1">&#39;&quot; to invalid value &#39;</span> <span class="o">+</span> <span class="nx">value</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <h3>.draw(mesh[, mode])</h3>

<p>Sets all uniform matrix attributes, binds all relevant buffers, and draws the
mesh geometry as indexed triangles or indexed lines. Set <code>mode</code> to <code>gl.LINES</code>
(and either add indices to <code>lines</code> or call <code>computeWireframe()</code>) to draw the
mesh in wireframe.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Shader</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">draw</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">mesh</span><span class="p">,</span> <span class="nx">mode</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">drawBuffers</span><span class="p">(</span><span class="nx">mesh</span><span class="p">.</span><span class="nx">vertexBuffers</span><span class="p">,</span>
        <span class="nx">mesh</span><span class="p">.</span><span class="nx">indexBuffers</span><span class="p">[</span><span class="nx">mode</span> <span class="o">==</span> <span class="nx">gl</span><span class="p">.</span><span class="nx">LINES</span> <span class="o">?</span> <span class="s1">&#39;lines&#39;</span> <span class="o">:</span> <span class="s1">&#39;triangles&#39;</span><span class="p">],</span>
        <span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="o">?</span> <span class="nx">gl</span><span class="p">.</span><span class="nx">TRIANGLES</span> <span class="o">:</span> <span class="nx">mode</span><span class="p">);</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <h3>.drawBuffers(vertexBuffers, indexBuffer, mode)</h3>

<p>Sets all uniform matrix attributes, binds all relevant buffers, and draws the
indexed mesh geometry. The <code>vertexBuffers</code> argument is a map from attribute
names to <code>Buffer</code> objects of type <code>gl.ARRAY_BUFFER</code>, <code>indexBuffer</code> is a <code>Buffer</code>
object of type <code>gl.ELEMENT_ARRAY_BUFFER</code>, and <code>mode</code> is a WebGL primitive mode
like <code>gl.TRIANGLES</code> or <code>gl.LINES</code>. This method automatically creates and caches
vertex attribute pointers for attributes as needed.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Shader</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">drawBuffers</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">vertexBuffers</span><span class="p">,</span> <span class="nx">indexBuffer</span><span class="p">,</span> <span class="nx">mode</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">uniforms</span><span class="p">({</span>
        <span class="nx">_gl_ModelViewMatrix</span><span class="o">:</span> <span class="nx">gl</span><span class="p">.</span><span class="nx">modelviewMatrix</span><span class="p">,</span>
        <span class="nx">_gl_ProjectionMatrix</span><span class="o">:</span> <span class="nx">gl</span><span class="p">.</span><span class="nx">projectionMatrix</span>
    <span class="p">});</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">needsMVP</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">uniforms</span><span class="p">({</span>
        <span class="nx">_gl_ModelViewProjectionMatrix</span><span class="o">:</span> <span class="nx">gl</span><span class="p">.</span><span class="nx">projectionMatrix</span><span class="p">.</span><span class="nx">multiply</span><span class="p">(</span><span class="nx">gl</span><span class="p">.</span><span class="nx">modelviewMatrix</span><span class="p">)</span>
    <span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>Create and enable attribute pointers as necessary.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">attribute</span> <span class="k">in</span> <span class="nx">vertexBuffers</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">buffer</span> <span class="o">=</span> <span class="nx">vertexBuffers</span><span class="p">[</span><span class="nx">attribute</span><span class="p">];</span>
        <span class="kd">var</span> <span class="nx">location</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">attributes</span><span class="p">[</span><span class="nx">attribute</span><span class="p">]</span> <span class="o">||</span>
            <span class="nx">gl</span><span class="p">.</span><span class="nx">getAttribLocation</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">program</span><span class="p">,</span> <span class="nx">attribute</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/^gl_/</span><span class="p">,</span> <span class="s1">&#39;_gl_&#39;</span><span class="p">));</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">location</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">attributes</span><span class="p">[</span><span class="nx">attribute</span><span class="p">]</span> <span class="o">=</span> <span class="nx">location</span><span class="p">;</span>
        <span class="nx">gl</span><span class="p">.</span><span class="nx">bindBuffer</span><span class="p">(</span><span class="nx">gl</span><span class="p">.</span><span class="nx">ARRAY_BUFFER</span><span class="p">,</span> <span class="nx">buffer</span><span class="p">.</span><span class="nx">buffer</span><span class="p">);</span>
        <span class="nx">gl</span><span class="p">.</span><span class="nx">enableVertexAttribArray</span><span class="p">(</span><span class="nx">location</span><span class="p">);</span>
        <span class="nx">gl</span><span class="p">.</span><span class="nx">vertexAttribPointer</span><span class="p">(</span><span class="nx">location</span><span class="p">,</span> <span class="nx">buffer</span><span class="p">.</span><span class="nx">buffer</span><span class="p">.</span><span class="nx">spacing</span><span class="p">,</span> <span class="nx">gl</span><span class="p">.</span><span class="nx">FLOAT</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
        <span class="nx">length</span> <span class="o">=</span> <span class="nx">buffer</span><span class="p">.</span><span class="nx">buffer</span><span class="p">.</span><span class="nx">length</span> <span class="o">/</span> <span class="nx">buffer</span><span class="p">.</span><span class="nx">buffer</span><span class="p">.</span><span class="nx">spacing</span><span class="p">;</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>Disable unused attribute pointers.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">attribute</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="nx">attributes</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">attribute</span> <span class="k">in</span> <span class="nx">vertexBuffers</span><span class="p">))</span> <span class="p">{</span>
            <span class="nx">gl</span><span class="p">.</span><span class="nx">disableVertexAttribArray</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">attributes</span><span class="p">[</span><span class="nx">attribute</span><span class="p">]);</span>
        <span class="p">}</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>Draw the geometry.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="nx">indexBuffer</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">gl</span><span class="p">.</span><span class="nx">bindBuffer</span><span class="p">(</span><span class="nx">gl</span><span class="p">.</span><span class="nx">ELEMENT_ARRAY_BUFFER</span><span class="p">,</span> <span class="nx">indexBuffer</span><span class="p">.</span><span class="nx">buffer</span><span class="p">);</span>
        <span class="nx">gl</span><span class="p">.</span><span class="nx">drawElements</span><span class="p">(</span><span class="nx">mode</span><span class="p">,</span> <span class="nx">indexBuffer</span><span class="p">.</span><span class="nx">buffer</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="nx">gl</span><span class="p">.</span><span class="nx">UNSIGNED_SHORT</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">gl</span><span class="p">.</span><span class="nx">drawArrays</span><span class="p">(</span><span class="nx">mode</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">length</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
<span class="p">};</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 